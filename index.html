<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø´ÙƒØ§Ø© - Ø§Ù„Ø®Ø¯Ù…Ø§Øª</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #e8e2f0 0%, #d4c5e8 100%);
            min-height: 100vh;
            direction: rtl;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo {
            width: 120px;
            height: 120px;
            margin: 0 auto 15px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
        }

        .app-name {
            font-size: 18px;
            font-weight: bold;
            color: #5a4a6b;
            margin-bottom: 5px;
        }

        .tagline {
            font-size: 10px;
            color: #7a6b8a;
        }

        .search-section {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
        }

        .search-bar {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #c4b5d4;
            border-radius: 25px;
            background: white;
            font-size: 14px;
            outline: none;
        }

        .language-btn {
            padding: 12px 20px;
            background: #c4b5d4;
            border: none;
            border-radius: 25px;
            color: #5a4a6b;
            font-size: 14px;
            cursor: pointer;
            position: relative;
        }

        .language-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 2px solid #c4b5d4;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(139, 90, 150, 0.2);
            min-width: 120px;
            z-index: 1000;
            display: none;
            margin-top: 5px;
        }

        .language-dropdown.show {
            display: block;
        }

        .language-option {
            padding: 12px 15px;
            cursor: pointer;
            transition: background 0.3s ease;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
            color: #5a4a6b;
        }

        .language-option:last-child {
            border-bottom: none;
        }

        .language-option:hover {
            background: #f8f5fb;
        }

        .language-option.active {
            background: #8b5a96;
            color: white;
        }

        .language-btn-container {
            position: relative;
        }

        .services-container {
            margin-bottom: 30px;
        }

        .services-scroll {
            display: flex;
            gap: 15px;
            overflow-x: auto;
            padding: 10px 0;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .services-scroll::-webkit-scrollbar {
            display: none;
        }

        .service-item {
            min-width: 120px;
            height: 50px;
            background: #8b5a96;
            border-radius: 25px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(139, 90, 150, 0.3);
        }

        .service-item:hover {
            background: #9d6ba8;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(139, 90, 150, 0.4);
        }

        .service-item.active {
            background: #6b4c75;
            transform: scale(1.05);
            box-shadow: 0 6px 16px rgba(139, 90, 150, 0.5);
        }

        .service-text {
            font-size: 12px;
            font-weight: 500;
            flex: 1;
        }

        .service-icon {
            font-size: 18px;
            margin-left: 8px;
        }

        .scroll-indicator {
            text-align: center;
            margin-top: 10px;
            color: #7a6b8a;
            font-size: 12px;
        }

        .map-section {
            margin-top: 20px;
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(139, 90, 150, 0.2);
        }

        .map-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .control-btn, .control-select {
            padding: 12px 16px;
            border: none;
            border-radius: 12px;
            background: white;
            color: #5a4a6b;
            border: 2px solid #8b5a96;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .control-btn:hover, .control-select:hover {
            background: #9d6ba8;
            transform: translateY(-2px);
        }

        .control-select {
            background: white;
            color: #5a4a6b;
            border: 2px solid #8b5a96;
        }

        #map {
            width: 100%;
            height: 450px;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(139, 90, 150, 0.2);
            margin-bottom: 20px;
        }

        #lists {
            background: #f8f5fb;
            border-radius: 16px;
            padding: 20px;
            max-height: 350px;
            overflow-y: auto;
        }

        #lists details {
            margin-bottom: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            overflow: hidden;
        }

        #lists summary {
            padding: 15px;
            background: #8b5a96;
            color: white;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            min-height: 44px;
        }

        .list-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.3s ease;
            min-height: 44px;
            background: white;
        }

        .list-item:hover {
            background: #f8f5fb;
        }

        .list-item:last-child {
            border-bottom: none;
        }

        .item-name {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            font-weight: 500;
        }

        .item-dist {
            color: #666;
            font-size: 14px;
            font-weight: 500;
        }

        .icon {
            font-size: 18px;
            width: 24px;
            text-align: center;
        }

        .cat-count {
            background: #c4b5d4;
            color: #5a4a6b;
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        @media (max-width: 375px) {
            .map-controls {
                grid-template-columns: 1fr;
            }
            
            #map {
                height: 350px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="LOGO2.png" alt="Ù…Ø´ÙƒØ§Ø©" class="logo">
        </div>

        <div class="search-section">
            <input type="text" class="search-bar" placeholder="Ø§Ù„Ø¨Ø­Ø«...">
            <div class="language-btn-container">
                <button class="language-btn" onclick="toggleLanguageDropdown()">
                    ğŸŒ Ø§Ù„Ù„ØºØ§Øª
                </button>
                <div class="language-dropdown" id="languageDropdown">
                    <div class="language-option active" onclick="selectLanguage('ar', 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©')">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</div>
                    <div class="language-option" onclick="selectLanguage('en', 'English')">English</div>
                    <div class="language-option" onclick="selectLanguage('ur', 'Ø§Ø±Ø¯Ùˆ')">Ø§Ø±Ø¯Ùˆ</div>
                </div>
            </div>
        </div>

        <div class="services-container">
            <div class="services-scroll">
                <div class="service-item" onclick="selectService('coffee')">
                    <span class="service-text">Ø§Ù„Ù…Ù‚Ø§Ù‡ÙŠ</span>
                    <img src="11.png" alt="Ù…Ù‚Ù‡Ù‰" class="services-scroll">
                </div>
                <div class="service-item" onclick="selectService('discount')">
                    <span class="service-text">Ø§Ù„Ø¹Ø±ÙˆØ¶</span>
                    <img src="9.png" alt="Ø§Ù„Ø¹Ø±ÙˆØ¶" class="services-scroll">
                </div>
                <div class="service-item" onclick="selectService('restroom')">
                    <span class="service-text">Ø¯ÙˆØ±Ø§Øª Ø§Ù„Ù…ÙŠØ§Ù‡</span>
                    <img src="17.png" alt="Ø¯ÙˆØ±Ø§Øª Ù…ÙŠØ§Ù‡" class="services-scroll">
                </div>
                <div class="service-item" onclick="selectService('water')">
                    <span class="service-text">Ù…ÙŠØ§Ù‡ Ø²Ù…Ø²Ù…</span>
                    <img src="6.png" alt="Ù…ÙŠØ§Ù‡ Ø²Ù…Ø²Ù…" class="services-scroll">
                </div>
                <div class="service-item" onclick="selectService('atm')">
                    <span class="service-text">Ø§Ù„ØµØ±Ø§ÙØ§Øª</span>
                    <img src="8.png" alt="ØµØ±Ø§Ù" class="services-scroll">
                </div>
                <div class="service-item" onclick="selectService('restaurant')">
                    <span class="service-text">Ø§Ù„Ù…Ø·Ø§Ø¹Ù…</span>
                    <img src="13.png" alt="Ù…Ø·Ø¹Ù…" class="services-scroll">
                </div>
                <div class="service-item" onclick="selectService('pharmacy')">
                    <span class="service-text">Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ§Øª</span>
                    <img src="7.png" alt="ØµÙŠØ¯Ù„ÙŠØ©" class="services-scroll">
                </div>
                <div class="service-item" onclick="selectService('hotel')">
                    <span class="service-text">Ø§Ù„ÙÙ†Ø§Ø¯Ù‚</span>
                    <img src="12.png" alt="ÙÙ†Ø§Ø¯Ù‚" class="services-scroll">
                </div>
                <div class="service-item" onclick="selectService('shopping')">
                    <span class="service-text">Ø§Ù„ØªØ³ÙˆÙ‚</span>
                    <img src="16.png" alt="ØªØ³ÙˆÙ‚" class="services-scroll">
                </div>
                <div class="service-item" onclick="selectService('transport')">
                    <span class="service-text">Ø§Ù„Ø¨Ù‚Ø§Ù„Ø©</span>
                    <img src="14.png" alt="Ø¨Ù‚Ø§Ù„Ø©" class="services-scroll">
                </div>
                <div class="service-item" onclick="selectService('medical')">
                    <span class="service-text">Ø§Ù„Ø·ÙˆØ§Ø±Ø¦</span>
                    <img src="15.png" alt="Ù…Ø³ØªØ´ÙÙ‰" class="services-scroll">
                </div>
                <div class="service-item" onclick="selectService('prayer')">
                    <span class="service-text">Ø£ÙˆÙ‚Ø§Øª Ø§Ù„ØµÙ„Ø§Ø©</span>
                    <img src="10.png" alt="Ø£ÙˆÙ‚Ø§Øª Ø§Ù„ØµÙ„Ø§Ø©" class="services-scroll">
                </div>
            </div>
            <div class="scroll-indicator">â† Ù…Ø±Ø± Ù„Ø±Ø¤ÙŠØ© Ø§Ù„Ù…Ø²ÙŠØ¯ â†’</div>
        </div>

        <div class="map-section">
            <div class="map-controls">
                <button class="control-btn" id="speech-toggle">ğŸ”Š ÙˆØµÙ Ø§Ù„Ø·Ø±ÙŠÙ‚</button>
                <button class="control-btn" id="voice-btn">ğŸ¤ ØªØ­Ø¯Ø« Ø¨ØµÙˆØªÙƒ</button>
            </div>

            <div id="map"></div>
            <div id="lists"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

    <script>
        const categories = {
            "Ø§Ù„Ù…Ø·Ø§Ø¹Ù…": {
                filter:'amenity=restaurant', 
                icon:'ğŸ½ï¸',
                customLocations: [
                    {
                        name: "Ù…Ø§Ùƒ - ØªØ­Øª Ø¨Ø±Ø¬ Ø§Ù„Ø³Ø§Ø¹Ø©",
                        lat: 21.4191392,
                        lon: 39.8246381,
                        type: "McDonald's Restaurant",
                        address: "ØªØ­Øª Ø¨Ø±Ø¬ Ø§Ù„Ø³Ø§Ø¹Ø©ØŒ Ù…ÙƒØ© Ø§Ù„Ù…ÙƒØ±Ù…Ø©",
                        hours: "24 Ø³Ø§Ø¹Ø©",
                        services: ["ÙˆØ¬Ø¨Ø§Øª Ø³Ø±ÙŠØ¹Ø©", "Ø¥ÙØ·Ø§Ø±", "Ù…Ø´Ø±ÙˆØ¨Ø§Øª", "Ø­Ù„ÙˆÙŠØ§Øª", "ÙˆØ¬Ø¨Ø§Øª Ø£Ø·ÙØ§Ù„"]
                    },
                    {
                        name: "Ø§Ù„Ø¨ÙŠÙƒ - ØªØ­Øª ÙÙ†Ø¯Ù‚ ÙˆØ£Ø¨Ø±Ø§Ø¬ Ù…ÙƒØ©",
                        lat: 21.4189055,
                        lon: 39.8246649,
                        type: "Al Baik Restaurant",
                        address: "ØªØ­Øª ÙÙ†Ø¯Ù‚ ÙˆØ£Ø¨Ø±Ø§Ø¬ Ù…ÙƒØ©ØŒ Ù…ÙƒØ© Ø§Ù„Ù…ÙƒØ±Ù…Ø©",
                        hours: "Ù…Ù† 11 ØµØ¨Ø§Ø­Ø§Ù‹ Ø¥Ù„Ù‰ 2 ØµØ¨Ø§Ø­Ø§Ù‹",
                        services: ["Ø¯Ø¬Ø§Ø¬ Ù…Ù‚Ù„ÙŠ", "Ø¨Ø±Ø¬Ø±", "Ù…Ø´Ø±ÙˆØ¨Ø§Øª", "ÙˆØ¬Ø¨Ø§Øª Ø¹Ø§Ø¦Ù„ÙŠØ©", "ØµÙˆØµ Ø§Ù„Ø¨ÙŠÙƒ Ø§Ù„Ø®Ø§Øµ"]
                    }
                ]
            },
            "Ø§Ù„ØµØ±Ø§ÙØ§Øª": {
                filter:'amenity=atm', 
                icon:'ğŸ§', 
                customLocations: [
                    {
                        name: "ØµØ±Ø§Ù Ø§Ù„Ø£Ù‡Ù„ÙŠ - Ø¨Ø±Ø¬ Ø§Ù„Ø³Ø§Ø¹Ø©",
                        lat: 21.4189847,
                        lon: 39.8250738,
                        type: "Al Ahli Bank ATM",
                        address: "Ø¨Ø±Ø¬ Ø§Ù„Ø³Ø§Ø¹Ø©ØŒ Ù…ÙƒØ© Ø§Ù„Ù…ÙƒØ±Ù…Ø©",
                        hours: "24 Ø³Ø§Ø¹Ø©",
                        services: ["Ø³Ø­Ø¨ Ù†Ù‚Ø¯ÙŠ", "Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø±ØµÙŠØ¯", "ØªØ­ÙˆÙŠÙ„ Ø£Ù…ÙˆØ§Ù„"]
                    },
                    {
                        name: "Ø´Ø±ÙƒØ© Ù…Ø¹ÙŠÙˆØ¶ Ø§Ù„Ø¬Ù…ÙŠØ¹ÙŠ Ù„Ù„ØµØ±Ø§ÙØ© Ø±Ù‚Ù…Ù¡",
                        lat: 21.4189446,
                        lon: 39.8251071,
                        type: "Maayouf Al-Jumaie Exchange",
                        address: "Ø¨Ø±Ø¬ Ø§Ù„Ø³Ø§Ø¹Ø©ØŒ Ù…ÙƒØ© Ø§Ù„Ù…ÙƒØ±Ù…Ø©",
                        hours: "Ù…Ù† 8 ØµØ¨Ø§Ø­Ø§Ù‹ Ø¥Ù„Ù‰ 12 Ù…Ù†ØªØµÙ Ø§Ù„Ù„ÙŠÙ„",
                        services: ["ØªØ­ÙˆÙŠÙ„ Ø¹Ù…Ù„Ø§Øª", "ØµØ±Ù Ø¹Ù…Ù„Ø§Øª Ø£Ø¬Ù†Ø¨ÙŠØ©", "Ø­ÙˆØ§Ù„Ø§Øª Ù…Ø§Ù„ÙŠØ©", "Ø®Ø¯Ù…Ø§Øª Ù…ØµØ±ÙÙŠØ©"]
                    }
                ]
            },
            "Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ§Øª": {
                filter:'amenity=pharmacy', 
                icon:'ğŸ’Š',
                customLocations: [
                    {
                        name: "ØµÙŠØ¯Ù„ÙŠØ© Ø²Ù‡Ø±Ø© Ø§Ù„Ø±ÙˆØ¶Ø©",
                        lat: 21.4191656,
                        lon: 39.8247227,
                        type: "Zahrat Al-Rawda Pharmacy",
                        address: "ØªØ­Øª ÙÙ†Ø¯Ù‚ ÙˆØ£Ø¨Ø±Ø§Ø¬ Ù…ÙƒØ©ØŒ Ù…ÙƒØ© Ø§Ù„Ù…ÙƒØ±Ù…Ø©",
                        hours: "Ù…Ù† 8 ØµØ¨Ø§Ø­Ø§Ù‹ Ø¥Ù„Ù‰ 12 Ù…Ù†ØªØµÙ Ø§Ù„Ù„ÙŠÙ„",
                        services: ["Ø£Ø¯ÙˆÙŠØ©", "Ù…Ø³ØªØ­Ø¶Ø±Ø§Øª ØªØ¬Ù…ÙŠÙ„", "ÙÙŠØªØ§Ù…ÙŠÙ†Ø§Øª", "Ø£Ø¯ÙˆÙŠØ© Ø¨Ø¯ÙˆÙ† ÙˆØµÙØ©", "Ù…Ø³ØªÙ„Ø²Ù…Ø§Øª Ø·Ø¨ÙŠØ©"]
                    }
                ]
            },
            "Ø§Ù„Ù…Ø³ØªØ´ÙÙŠØ§Øª": {filter:'amenity=hospital', icon:'ğŸ¥'},
            "Ø§Ù„Ù…Ø­Ù„Ø§Øª": {filter:'shop=*', icon:'ğŸ›ï¸'},
            "Ø§Ù„Ù…Ù‚Ø§Ù‡ÙŠ": {filter:'amenity=cafe', icon:'â˜•'},
            "Ø¯ÙˆØ±Ø§Øª Ø§Ù„Ù…ÙŠØ§Ù‡": {filter:'amenity=toilets', icon:'ğŸš»'},
            "Ø§Ù„ÙÙ†Ø§Ø¯Ù‚": {filter:'tourism=hotel', icon:'ğŸ¨'},
            "Ø§Ù„Ø¨Ù‚Ø§Ù„Ø©": {
                filter:'shop=supermarket', 
                icon:'ğŸ›’', 
                customLocations: [
                    {
                        name: "Ø³ÙˆØ¨Ø±Ù…Ø§Ø±ÙƒØª Ø¨Ù† Ø¯Ø§ÙˆÙˆØ¯ - Ø¨Ø±Ø¬ Ø§Ù„Ø³Ø§Ø¹Ø©",
                        lat: 21.4191089,
                        lon: 39.8247096,
                        type: "Bin Dawood Supermarket",
                        address: "Ø¨Ø±Ø¬ Ø§Ù„Ø³Ø§Ø¹Ø©ØŒ Ù…ÙƒØ© Ø§Ù„Ù…ÙƒØ±Ù…Ø©",
                        hours: "Ù…Ù† 6 ØµØ¨Ø§Ø­Ø§Ù‹ Ø¥Ù„Ù‰ 2 ØµØ¨Ø§Ø­Ø§Ù‹",
                        services: ["Ù…ÙˆØ§Ø¯ ØºØ°Ø§Ø¦ÙŠØ©", "Ù…Ù†ØªØ¬Ø§Øª Ø·Ø§Ø²Ø¬Ø©", "Ù…Ø®Ø¨ÙˆØ²Ø§Øª", "Ù…Ù†ØªØ¬Ø§Øª Ù…Ù†Ø²Ù„ÙŠØ©", "Ø£Ø¯ÙˆØ§Øª Ø´Ø®ØµÙŠØ©"]
                    }
                ]
            }
        };

        let userLocation = [21.4225,39.8262];
        let speechEnabled = true;
        let lang = "ar-SA";
        let map, userMarker, routingControl;
        let allPlaces = [];

        function initMap() {
            map = L.map('map', {
                zoomControl: true,
                attributionControl: false,
                tap: true,
                touchZoom: true,
                doubleClickZoom: true
            }).setView(userLocation, 16);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
                attribution:'&copy; OpenStreetMap contributors' 
            }).addTo(map);

            userMarker = L.marker(userLocation).addTo(map).bindPopup("Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ").openPopup();

            navigator.geolocation.getCurrentPosition(pos => {
                userLocation = [pos.coords.latitude, pos.coords.longitude];
                userMarker.setLatLng(userLocation).bindPopup("Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ");
                map.setView(userLocation, 16);
                loadPlaces(userLocation[0], userLocation[1]);
            }, () => {
                loadPlaces(userLocation[0], userLocation[1]);
            });
        }

        function selectService(serviceType) {
            document.querySelectorAll('.service-item').forEach(item => {
                item.classList.remove('active');
            });
            
            event.target.closest('.service-item').classList.add('active');
            
            const serviceName = getServiceName(serviceType);
            if (categories[serviceName]) {
                loadSpecificService(serviceName);
                
                // Ù…Ø³Ø­ Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
                map.eachLayer(function (layer) {
                    if (layer instanceof L.Marker && layer !== userMarker) {
                        map.removeLayer(layer);
                    }
                });
            }
        }

        function loadSpecificService(serviceName) {
            const listsDiv = document.getElementById("lists");
            listsDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: #8b5a96;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';
            
            const cat = categories[serviceName];
            if (!cat) return;
            
            let allElements = [];
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ù…Ø®ØµØµØ© Ø£ÙˆÙ„Ø§Ù‹ (Ù…Ø«Ù„ ØµØ±Ø§Ù Ø§Ù„Ø£Ù‡Ù„ÙŠ)
            if (cat.customLocations) {
                cat.customLocations.forEach(location => {
                    const dist = calcDistance(userLocation[0], userLocation[1], location.lat, location.lon);
                    allElements.push({
                        lat: location.lat,
                        lon: location.lon,
                        tags: { name: location.name },
                        distance: dist,
                        isCustom: true,
                        customData: location
                    });
                });
            }
            
            // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† OpenStreetMap
            const overpassUrl = `https://overpass-api.de/api/interpreter?data=[out:json];node[${cat.filter}](around:1500,${userLocation[0]},${userLocation[1]});out;`;
            
            fetch(overpassUrl)
                .then(res => res.json())
                .then(data => {
                    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† OpenStreetMap
                    data.elements.forEach(el => {
                        const dist = calcDistance(userLocation[0], userLocation[1], el.lat, el.lon);
                        allElements.push({ ...el, distance: dist, isCustom: false });
                    });
                    
                    // ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ©
                    allElements.sort((a, b) => a.distance - b.distance);
                    
                    let html = `<details open><summary>${cat.icon} ${serviceName} <span class="cat-count">${allElements.length}</span></summary>`;
                    
                    allElements.forEach(el => {
                        const placeLat = el.lat;
                        const placeLon = el.lon;
                        let placeName = el.tags.name || "Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…";
                        const dist = el.distance.toFixed(2);
                        
                        // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
                        const marker = L.marker([placeLat, placeLon]).addTo(map);
                        
                        // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
                        let popupContent;
                        if (el.isCustom && el.customData) {
                            popupContent = `
                                <div style="text-align: center; min-width: 200px;">
                                    <h3 style="color: #8b5cf6; margin-bottom: 10px;">${placeName}</h3>
                                    <p style="margin: 5px 0;"><strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> ${el.customData.address}</p>
                                    <p style="margin: 5px 0;"><strong>Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„:</strong> ${el.customData.hours}</p>
                                    <p style="margin: 5px 0;"><strong>Ø§Ù„Ù…Ø³Ø§ÙØ©:</strong> ${dist} ÙƒÙ…</p>
                                    <div style="margin-top: 10px;">
                                        <strong>Ø§Ù„Ø®Ø¯Ù…Ø§Øª:</strong><br>
                                        ${el.customData.services.map(service => `â€¢ ${service}`).join('<br>')}
                                    </div>
                                    <button onclick="getDirections(${placeLat}, ${placeLon}, '${placeName}')" 
                                            style="background: #8b5cf6; color: white; border: none; padding: 8px 16px; border-radius: 8px; margin-top: 10px; cursor: pointer;">
                                        Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø§ØªØ¬Ø§Ù‡Ø§Øª
                                    </button>
                                </div>
                            `;
                        } else {
                            popupContent = `${placeName}<br>${dist} ÙƒÙ…`;
                        }
                        
                        marker.bindPopup(popupContent);
                        
                        html += `<div class="list-item" onclick="focusPlace(${placeLat},${placeLon},'${placeName}')">
                                  <span class="item-name">
                                    <span class="icon">${cat.icon}</span>
                                    ${placeName}
                                  </span>
                                  <span class="item-dist">${dist} ÙƒÙ…</span>
                                </div>`;
                    });
                    
                    html += "</details>";
                    listsDiv.innerHTML = html;
                })
                .catch(error => {
                    console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
                    listsDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: #d32f2f;">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>';
                });
        }

        function getDirections(lat, lon, name) {
            if(routingControl) map.removeControl(routingControl);
            routingControl = L.Routing.control({
                waypoints: [L.latLng(userLocation[0], userLocation[1]), L.latLng(lat, lon)],
                lineOptions: {styles: [{color: '#8b5cf6', opacity: 0.8, weight: 5}]},
                addWaypoints: false,
                draggableWaypoints: false,
                routeWhileDragging: false,
                showAlternatives: false,
                createMarker: () => null
            }).addTo(map);

            map.setView([lat, lon], 17);
            speak(`ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø·Ø±ÙŠÙ‚ Ø¥Ù„Ù‰ ${name}`);
        }

        function getServiceName(serviceType) {
            const serviceNames = {
                'coffee': 'Ø§Ù„Ù…Ù‚Ø§Ù‡ÙŠ',
                'discount': 'Ø§Ù„Ø¹Ø±ÙˆØ¶',
                'restroom': 'Ø¯ÙˆØ±Ø§Øª Ø§Ù„Ù…ÙŠØ§Ù‡',
                'water': 'Ù…ÙŠØ§Ù‡ Ø²Ù…Ø²Ù…',
                'atm': 'Ø§Ù„ØµØ±Ø§ÙØ§Øª',
                'restaurant': 'Ø§Ù„Ù…Ø·Ø§Ø¹Ù…',
                'pharmacy': 'Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ§Øª',
                'hotel': 'Ø§Ù„ÙÙ†Ø§Ø¯Ù‚',
                'shopping': 'Ø§Ù„ØªØ³ÙˆÙ‚',
                'transport': 'Ø§Ù„Ø¨Ù‚Ø§Ù„Ø©',
                'medical': 'Ø§Ù„Ø·ÙˆØ§Ø±Ø¦',
                'prayer': 'Ø£ÙˆÙ‚Ø§Øª Ø§Ù„ØµÙ„Ø§Ø©'
            };
            return serviceNames[serviceType] || serviceType;
        }

        function toggleLanguageDropdown() {
            const dropdown = document.getElementById('languageDropdown');
            dropdown.classList.toggle('show');
        }

        function selectLanguage(langCode, langName) {
            document.querySelectorAll('.language-option').forEach(option => {
                option.classList.remove('active');
            });
            
            event.target.classList.add('active');
            
            const btn = document.querySelector('.language-btn');
            btn.innerHTML = `ğŸŒ ${langName}`;
            
            document.getElementById('languageDropdown').classList.remove('show');
            
            lang = langCode === 'ar' ? 'ar-SA' : langCode === 'en' ? 'en-US' : 'ur-PK';
        }

        document.addEventListener('click', function(event) {
            const container = document.querySelector('.language-btn-container');
            if (!container.contains(event.target)) {
                document.getElementById('languageDropdown').classList.remove('show');
            }
        });


        function loadPlaces(lat, lon) {
            const listsDiv = document.getElementById("lists");
            listsDiv.innerHTML = "";
            allPlaces = [];
            
            for(const [name, cat] of Object.entries(categories)) {
                const overpassUrl = `https://overpass-api.de/api/interpreter?data=[out:json];node[${cat.filter}](around:1500,${lat},${lon});out;`;
                
                fetch(overpassUrl)
                    .then(res => res.json())
                    .then(data => {
                        let html = `<details><summary>${cat.icon} ${name} <span class="cat-count">${data.elements.length}</span></summary>`;
                        
                        data.elements.forEach((el, index) => {
                            const placeLat = el.lat;
                            const placeLon = el.lon;
                            let placeName = el.tags.name || "Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…";
                            
                            allPlaces.push({name: placeName, lat: placeLat, lon: placeLon});
                            
                            const dist = calcDistance(userLocation[0], userLocation[1], placeLat, placeLon).toFixed(2);
                            
                            L.marker([placeLat, placeLon]).addTo(map).bindPopup(`${placeName}<br>${dist} ÙƒÙ…`);
                            
                            html += `<div class="list-item" onclick="focusPlace(${placeLat},${placeLon},'${placeName}')">
                                      <span class="item-name">
                                        <span class="icon">${cat.icon}</span>
                                        ${placeName}
                                      </span>
                                      <span class="item-dist">${dist} ÙƒÙ…</span>
                                    </div>`;
                        });
                        html += "</details>";
                        listsDiv.innerHTML += html;
                    });
            }
        }

        function focusPlace(lat, lon, name) {
            map.setView([lat, lon], 18);
            L.popup().setLatLng([lat, lon]).setContent(name).openOn(map);
            speak(name);

            if(!speechEnabled) return;

            if(routingControl) map.removeControl(routingControl);
            routingControl = L.Routing.control({
                waypoints: [L.latLng(userLocation[0], userLocation[1]), L.latLng(lat, lon)],
                lineOptions: {styles: [{color: '#8b5a96', opacity: 0.8, weight: 5}]},
                addWaypoints: false,
                draggableWaypoints: false,
                routeWhileDragging: false,
                showAlternatives: false,
                createMarker: () => null
            }).addTo(map);

            describeRoute(userLocation, [lat, lon], name);
        }

        function describeRoute(start, end, placeName) {
            const latDiff = end[0] - start[0];
            const lonDiff = end[1] - start[1];
            let text = `Ø§ØªØ¬Ù‡ Ù…Ù† Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¥Ù„Ù‰ ${placeName}. `;
            text += Math.abs(latDiff) > Math.abs(lonDiff) ? (latDiff > 0 ? "ØªØ­Ø±Ùƒ Ø´Ù…Ø§Ù„Ø§Ù‹. " : "ØªØ­Ø±Ùƒ Ø¬Ù†ÙˆØ¨Ø§Ù‹. ") : (lonDiff > 0 ? "ØªØ­Ø±Ùƒ Ø´Ø±Ù‚Ø§Ù‹. " : "ØªØ­Ø±Ùƒ ØºØ±Ø¨Ø§Ù‹. ");
            speak(text);
        }

        function speak(text) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = lang;
            speechSynthesis.speak(utterance);
        }

        function calcDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2)**2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        document.getElementById("speech-toggle").addEventListener("click", () => {
            speechEnabled = !speechEnabled;
            const btn = document.getElementById("speech-toggle");
            btn.innerHTML = speechEnabled ? "ğŸ”Š ÙˆØµÙ Ø§Ù„Ø·Ø±ÙŠÙ‚" : "ğŸ”‡ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙˆØµÙ";
            btn.style.background = speechEnabled ? "#8b5a96" : "#999";
        });

        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.lang = lang;
        recognition.continuous = false;
        recognition.interimResults = false;

        document.getElementById("voice-btn").addEventListener("click", () => {
            recognition.lang = lang;
            recognition.start();
        });

        recognition.onresult = function(event) {
            const speech = event.results[0][0].transcript.toLowerCase();
            let found = allPlaces.find(p => p.name.toLowerCase().includes(speech));
            if(found) {
                focusPlace(found.lat, found.lon, found.name);
            } else {
                speak("Ø§Ù„Ù…ÙƒØ§Ù† ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
            }
        }


        window.addEventListener('load', () => {
            initMap();
        });
    </script>
</body>
</html>
